<div class="container">
  <div class="row">
    <div class="col-lg-12">

      <img src="./assets/images/web-data-extraction.png" alt="Image representing the processing to extract data from the web" class="img-responsive"/>

      <h1 class="title">Scraping data from DataSport</h1>

      <p>Your goal is to get data from the <a href="https://www.datasport.com/en/">DataSport</a>, specially runs over years. But there is a lot (more than 2200 runs events), so we focus at the beginning on a single run: the Lausanne Marathon 2016. This will help us to understand how data are presented and how to get them. Then we will try to get all Marathon Lausanne (between 1999 and 2016), by applying the same approach than before. Finally, we will try to get all runs of some people with a different technique that use a little bit of reverse engineering to decode the DataSport API.</p>

      <div class="thumbnail thumbnail-medium">
        <img src="./assets/images/datasport-screenshot.png" alt="Screenshot of the datasport website"/>
        <div class="caption">
          <p>Screenshot of the datasport website</p>
        </div>
      </div>

      <h2 id="lamara-2016">Lausanne Marathon 2016</h2>

      <p>First, we begin with the <a href="https://services.datasport.com/2016/lauf/lamara/">Lausanne Marathon 2016</a>. There is a lot of possibilities to get all runners information, but the easiest is to use the alphabetical order, so we are sure to have everybody.</p>

      <div class="thumbnail thumbnail-large">
        <img src="./assets/images/datasport-lausanne-marathon-2016-runners-a-screenshot.png" alt="Screenshot of runners with name start with letter A in the Lausanne Marathon 2016 from datasport"/>
        <div class="caption">
          <p>Screenshot of runners with name start with letter A in the Lausanne Marathon 2016 from datasport</p>
        </div>
      </div>

      <p>The data is not very easy to read by a program, even if it is presentable for human there is no structure behind, only spaces. So we work on a simple probabilistic algorithm to split at the right place to make columns. The algorithm count the number of blank (space) in a column, more the count is large more the probability to split is high. We also improve the split, by regarding the header to avoid a split in a middle of a column name. Finally, we use in addition the <a href="http://docs.astropy.org/en/stable/io/ascii/">ascii</a> part of the <a href="http://www.astropy.org/">astropy</a> library that rebuild the table.</p>

      <div class="cell">
        <div class="input">
          <div class="highlight hl-ipython3">
            <pre><span class="n">read_page</span><span class="p">(</span><span class="s1">&#39;https://services.datasport.com/2016/lauf/lamara/alfaa.htm&#39;</span><span class="p">,</span> <span class="s1">&#39;no-check&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></pre>
          </div>
        </div>
        <div class="output">
          <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                <tr style="text-align: right;">
                  <th></th>
                  <th>catégorie</th>
                  <th>rang</th>
                  <th>nom</th>
                  <th>an</th>
                  <th>lieu</th>
                  <th>équipe</th>
                  <th>pénalité</th>
                  <th>temps</th>
                  <th>retard</th>
                  <th>doss</th>
                  <th>overall</th>
                  <th>moyenne</th>
                  <th>acode</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <th>0</th>
                  <td>21-H50</td>
                  <td>147.</td>
                  <td>Abaidia Jilani</td>
                  <td>1966</td>
                  <td>St-Légier-La Chiésaz</td>
                  <td>NaN</td>
                  <td>NaN</td>
                  <td>1:45.28,4</td>
                  <td>25.56,8</td>
                  <td>(5082)</td>
                  <td>diplôme foto video  21-Hom</td>
                  <td>1241.    4.59</td>
                  <td>1KSQJLYCM</td>
                </tr>
                <tr>
                  <th>1</th>
                  <td>21-D40</td>
                  <td>81.</td>
                  <td>Abaidia Sandrine</td>
                  <td>1972</td>
                  <td>St-Légier</td>
                  <td>NaN</td>
                  <td>NaN</td>
                  <td>1:49.40,8</td>
                  <td>24.09,5</td>
                  <td>(5080)</td>
                  <td>diplôme foto video  21-Fem</td>
                  <td>289.     5.11</td>
                  <td>J2R2H9J5F</td>
                </tr>
                <tr>
                  <th>2</th>
                  <td>M-Fille3</td>
                  <td>33.</td>
                  <td>Abaidia Selma</td>
                  <td>2006</td>
                  <td>St-Légier-La Chiésaz</td>
                  <td>NaN</td>
                  <td>NaN</td>
                  <td>7.12,2</td>
                  <td>1.36,3</td>
                  <td>(22010)</td>
                  <td>diplôme foto video  ---</td>
                  <td>4.48</td>
                  <td>T4HUZEMR7</td>
                </tr>
                <tr>
                  <th>3</th>
                  <td>10W-NW</td>
                  <td>NaN</td>
                  <td>Abansir Florence</td>
                  <td>1971</td>
                  <td>Lausanne</td>
                  <td>NaN</td>
                  <td>NaN</td>
                  <td>1:28.29,2</td>
                  <td>NaN</td>
                  <td>(18024)</td>
                  <td>diplôme foto video  ---</td>
                  <td>8.50</td>
                  <td>73E4NWC9K</td>
                </tr>
                <tr>
                  <th>4</th>
                  <td>21-H60</td>
                  <td>103.</td>
                  <td>Abb Jochen</td>
                  <td>1948</td>
                  <td>Ernen</td>
                  <td>NaN</td>
                  <td>NaN</td>
                  <td>2:50.40,7</td>
                  <td>1:21.28,7</td>
                  <td>(8381)</td>
                  <td>diplôme foto video  21-Hom</td>
                  <td>2921.    8.05</td>
                  <td>X7U8LH7Y1</td>
                </tr>
                </tbody>
              </table>
          </div>
        </div>
        <div class="caption">
          Full code available <a href="https://github.com/antitoine/ADAEPFL-Project/blob/master/Scraping/DataSport/scraping_by_runs.ipynb">here</a>
        </div>
      </div>

      <p>Now, we just need to extract links to all alphabetic list and extract data.</p>

      <div class="cell">
        <div class="input">
          <div class=" highlight hl-ipython3">
            <pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">get_all_data_from_page</span><span class="p">(</span><span class="s1">&#39;https://services.datasport.com/2016/lauf/lamara/&#39;</span><span class="p">)</span>
</pre>
          </div>
        </div>
        <div class="output">
          <div>
<pre>1/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAA.HTM
2/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAB.HTM
3/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAC.HTM
4/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAD.HTM
5/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAE.HTM
6/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAF.HTM
7/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAG.HTM
8/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAH.HTM
9/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAI.HTM
10/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAJ.HTM
11/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAK.HTM
12/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAL.HTM
13/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAM.HTM
14/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAN.HTM
15/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAO.HTM
16/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAP.HTM
17/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAQ.HTM
18/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAR.HTM
19/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAS.HTM
20/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAT.HTM
21/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAU.HTM
22/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAV.HTM
23/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAW.HTM
24/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAX.HTM
25/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAY.HTM
26/26 - Processing https://services.datasport.com/2016/lauf/lamara/ALFAZ.HTM
</pre>
          </div>
        </div>
        <div class="caption">
          Full code available <a href="https://github.com/antitoine/ADAEPFL-Project/blob/master/Scraping/DataSport/scraping_by_runs.ipynb">here</a>
        </div>
      </div>

      <p>Like you can see, we need to make an extra work to clean and rename columns, parse dates and times and remove some fields not useful.</p>

      <div class="cell">
        <div class="input">
          <div class=" highlight hl-ipython3">
            <pre><span></span><span class="n">clean_dataframe</span><span class="p">(</span><span class="n">df_2016_lauf_lamara_ALFAA</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
          </div>
        </div>
        <div class="output">
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
              <tr style="text-align: right;">
                <th></th>
                <th>number</th>
                <th>time</th>
                <th>category</th>
                <th>name</th>
                <th>team</th>
                <th>birthday</th>
                <th>acode</th>
                <th>rank</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <th>0</th>
                <td>5082</td>
                <td>1900-01-01 01:45:28.400000</td>
                <td>21-H50</td>
                <td>Abaidia Jilani</td>
                <td>NaN</td>
                <td>1966-01-01 00:00:00</td>
                <td>1KSQJLYCM</td>
                <td>147.0</td>
              </tr>
              <tr>
                <th>1</th>
                <td>5080</td>
                <td>1900-01-01 01:49:40.800000</td>
                <td>21-D40</td>
                <td>Abaidia Sandrine</td>
                <td>NaN</td>
                <td>1972-01-01 00:00:00</td>
                <td>J2R2H9J5F</td>
                <td>81.0</td>
              </tr>
              <tr>
                <th>2</th>
                <td>22010</td>
                <td>1900-01-01 00:07:12.200000</td>
                <td>M-Fille3</td>
                <td>Abaidia Selma</td>
                <td>NaN</td>
                <td>2006-01-01 00:00:00</td>
                <td>T4HUZEMR7</td>
                <td>33.0</td>
              </tr>
              <tr>
                <th>3</th>
                <td>18024</td>
                <td>1900-01-01 01:28:29.200000</td>
                <td>10W-NW</td>
                <td>Abansir Florence</td>
                <td>NaN</td>
                <td>1971-01-01 00:00:00</td>
                <td>73E4NWC9K</td>
                <td>NaN</td>
              </tr>
              <tr>
                <th>4</th>
                <td>8381</td>
                <td>1900-01-01 02:50:40.700000</td>
                <td>21-H60</td>
                <td>Abb Jochen</td>
                <td>NaN</td>
                <td>1948-01-01 00:00:00</td>
                <td>X7U8LH7Y1</td>
                <td>103.0</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="caption">
          Full code available <a href="https://github.com/antitoine/ADAEPFL-Project/blob/master/Scraping/DataSport/merge_and_clean.ipynb">here</a>
        </div>
      </div>

      <p>Finally, we merge all tables in a single one.</p>

      <div class="cell">
        <div class="input">
          <div class="highlight hl-ipython3">
            <pre><span></span><span class="n">dataframes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">):</span>
    <span class="n">uncleaned_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cleaned_df</span> <span class="o">=</span> <span class="n">clean_dataframe</span><span class="p">(</span><span class="n">uncleaned_df</span><span class="p">)</span>
    <span class="n">dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_df</span><span class="p">)</span>
<span></span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)</span>
<span class="n">merged_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
          </div>
        </div>
        <div class="output">
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
              <tr style="text-align: right;">
                <th></th>
                <th>number</th>
                <th>time</th>
                <th>category</th>
                <th>name</th>
                <th>team</th>
                <th>birthday</th>
                <th>acode</th>
                <th>rank</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <th>0</th>
                <td>11404</td>
                <td>1900-01-01 00:50:26.600000</td>
                <td>10-H40</td>
                <td>Waardenburg George</td>
                <td>NaN</td>
                <td>1976-01-01 00:00:00</td>
                <td>CPQP6ZGUB</td>
                <td>285.0</td>
              </tr>
              <tr>
                <th>1</th>
                <td>13468</td>
                <td>1900-01-01 00:53:10.800000</td>
                <td>10-JunG</td>
                <td>Waeber Jean</td>
                <td>NaN</td>
                <td>1997-01-01 00:00:00</td>
                <td>X4HC5EYRT</td>
                <td>186.0</td>
              </tr>
              <tr>
                <th>2</th>
                <td>11449</td>
                <td>1900-01-01 00:48:47.500000</td>
                <td>10-D50</td>
                <td>Waeber Marie-Jo</td>
                <td>NaN</td>
                <td>1963-01-01 00:00:00</td>
                <td>HAP8H6A7Q</td>
                <td>17.0</td>
              </tr>
              <tr>
                <th>3</th>
                <td>6523</td>
                <td>1900-01-01 02:03:58.500000</td>
                <td>21-H30</td>
                <td>Waeber Pascal</td>
                <td>NaN</td>
                <td>1979-01-01 00:00:00</td>
                <td>ZT9BYS5M3</td>
                <td>778.0</td>
              </tr>
              <tr>
                <th>4</th>
                <td>6441</td>
                <td>1900-01-01 01:34:50.700000</td>
                <td>21-D40</td>
                <td>Waeber Yvette</td>
                <td>NaN</td>
                <td>1970-01-01 00:00:00</td>
                <td>2T9WCSAM7</td>
                <td>11.0</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="caption">
          Full code available <a href="https://github.com/antitoine/ADAEPFL-Project/blob/master/Scraping/DataSport/merge_and_clean.ipynb">here</a>
        </div>
      </div>

      <p>The final csv file is available <a href="https://raw.githubusercontent.com/antitoine/ADAEPFL-Project/master/Scraping/DataSport/Data/Lausanne_Marathon_2016.csv">here <i class="fa fa-file-text-o" aria-hidden="true"></i></a></p>

      <h2 id="lamara-all">Lausanne Marathon 1999 to 2016</h2>

      <p>WIP</p>

      <h2 id="runners">Runners</h2>

      <p>WIP</p>

    </div>
  </div>
</div>
